{"version":3,"file":"angular-oauth2-oidc-jwks.js","sources":["../../../projects/angular-oauth2-oidc-jwks/src/lib/jwks-validation-handler.ts","../../../projects/angular-oauth2-oidc-jwks/src/angular-oauth2-oidc-jwks.ts"],"names":[],"mappings":"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","sourcesContent":["import * as rs from 'jsrsasign';\nimport {\n  AbstractValidationHandler,\n  ValidationParams,\n} from 'angular-oauth2-oidc';\n\n/**\n * Validates the signature of an id_token against one\n * of the keys of an JSON Web Key Set (jwks).\n *\n * This jwks can be provided by the discovery document.\n */\nexport class JwksValidationHandler extends AbstractValidationHandler {\n  /**\n   * Allowed algorithms\n   */\n  allowedAlgorithms: string[] = [\n    'HS256',\n    'HS384',\n    'HS512',\n    'RS256',\n    'RS384',\n    'RS512',\n    'ES256',\n    'ES384',\n    'PS256',\n    'PS384',\n    'PS512',\n  ];\n\n  /**\n   * Time period in seconds the timestamp in the signature can\n   * differ from the current time.\n   */\n  gracePeriodInSec = 600;\n\n  validateSignature(params: ValidationParams, retry = false): Promise<any> {\n    if (!params.idToken) throw new Error('Parameter idToken expected!');\n    if (!params.idTokenHeader)\n      throw new Error('Parameter idTokenHandler expected.');\n    if (!params.jwks) throw new Error('Parameter jwks expected!');\n\n    if (\n      !params.jwks['keys'] ||\n      !Array.isArray(params.jwks['keys']) ||\n      params.jwks['keys'].length === 0\n    ) {\n      throw new Error('Array keys in jwks missing!');\n    }\n\n    // console.debug('validateSignature: retry', retry);\n\n    let kid: string = params.idTokenHeader['kid'];\n    let keys: object[] = params.jwks['keys'];\n    let key: object;\n\n    let alg = params.idTokenHeader['alg'];\n\n    if (kid) {\n      key = keys.find((k) => k['kid'] === kid /* && k['use'] === 'sig' */);\n    } else {\n      let kty = this.alg2kty(alg);\n      let matchingKeys = keys.filter(\n        (k) => k['kty'] === kty && k['use'] === 'sig'\n      );\n\n      /*\n            if (matchingKeys.length == 0) {\n                let error = 'No matching key found.';\n                console.error(error);\n                return Promise.reject(error);\n            }*/\n      if (matchingKeys.length > 1) {\n        let error =\n          'More than one matching key found. Please specify a kid in the id_token header.';\n        console.error(error);\n        return Promise.reject(error);\n      } else if (matchingKeys.length === 1) {\n        key = matchingKeys[0];\n      }\n    }\n\n    if (!key && !retry && params.loadKeys) {\n      return params\n        .loadKeys()\n        .then((loadedKeys) => (params.jwks = loadedKeys))\n        .then((_) => this.validateSignature(params, true));\n    }\n\n    if (!key && retry && !kid) {\n      let error = 'No matching key found.';\n      console.error(error);\n      return Promise.reject(error);\n    }\n\n    if (!key && retry && kid) {\n      let error =\n        'expected key not found in property jwks. ' +\n        'This property is most likely loaded with the ' +\n        'discovery document. ' +\n        'Expected key id (kid): ' +\n        kid;\n\n      console.error(error);\n      return Promise.reject(error);\n    }\n\n    let keyObj = rs.KEYUTIL.getKey(key);\n    let validationOptions = {\n      alg: this.allowedAlgorithms,\n      gracePeriod: this.gracePeriodInSec,\n    };\n    let isValid = rs.KJUR.jws.JWS.verifyJWT(\n      params.idToken,\n      keyObj,\n      validationOptions\n    );\n\n    if (isValid) {\n      return Promise.resolve();\n    } else {\n      return Promise.reject('Signature not valid');\n    }\n  }\n\n  private alg2kty(alg: string) {\n    switch (alg.charAt(0)) {\n      case 'R':\n        return 'RSA';\n      case 'E':\n        return 'EC';\n      default:\n        throw new Error('Cannot infer kty from alg: ' + alg);\n    }\n  }\n\n  calcHash(valueToHash: string, algorithm: string): Promise<string> {\n    let hashAlg = new rs.KJUR.crypto.MessageDigest({ alg: algorithm });\n    let result = hashAlg.digestString(valueToHash);\n    let byteArrayAsString = this.toByteArrayAsString(result);\n    return Promise.resolve(byteArrayAsString);\n  }\n\n  toByteArrayAsString(hexString: string) {\n    let result = '';\n    for (let i = 0; i < hexString.length; i += 2) {\n      let hexDigit = hexString.charAt(i) + hexString.charAt(i + 1);\n      let num = parseInt(hexDigit, 16);\n      result += String.fromCharCode(num);\n    }\n    return result;\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"]}